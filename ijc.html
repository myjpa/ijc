<head>
	<title>interactive javascript console</title>
	<script src="jquery-1.4.2.min.js" type="text/javascript"></script>
</head>
<body>
	<form id="console_ijcwindow">
		<div>
			<textarea id="history_ijcwindow" readonly="true" rows="10" cols="80" style="width:100%;height:80%"></textarea>
		</div>
		<div>
			<input type="text" id="code_ijcwindow" style="width:100%"></input>
			<input type="submit" value="eval"> </input>
		</div>
	</form>
</body>
<script type="text/javascript">
	window.ijc = {
		//memeber variables
console_ijcwindow : document.getElementById("console_ijcwindow"),
										code_ijcwindow : document.getElementById("code_ijcwindow"),
										history_ijcwindow : document.getElementById("history_ijcwindow"),
										mixedin : false,
										cmd_history : [],
										history_cursor : 0,
										//member functions
										//mixin, unmixin ijc into global namespace
										mixin : function(){ 
											if(!ijc.mixedin){
												for(key in ijc) {window["__original__"+key]=window[key];window[key] = ijc[key];} 
												ijc.mixedin = true;
											}
										},
unmixin : function(){
						if(ijc.mixedin){
							for(key in ijc) {window[key] = window["__original__"+key];} 
							ijc.mixedin = false;
						}
					},
					//manipulate cmd_history
add_history : function(record){
								if(ijc.cmd_history[ijc.cmd_history.length-1]!=record) 
									ijc.cmd_history.push(record);
								ijc.history_cursor = ijc.cmd_history.length;

							},
prev_history : function(){
								 return ijc.history_cursor>0 ? ijc.cmd_history[--ijc.history_cursor] : undefined;
							 },
next_history : function(){
								 return ijc.history_cursor<ijc.cmd_history.length-1 ? ijc.cmd_history[++ijc.history_cursor] : undefined;
							 },

							 //output to stdout
print : function(text) {
					ijc.history_ijcwindow.value+=text;
					ijc.history_ijcwindow.scrollTop=ijc.history_ijcwindow.scrollHeight;
				},
puts : function(text) {
				 ijc.print(text+"\n");
			 },
inspect : function(obj) {
						str = obj;
						if(typeof(obj)=='object'){
							if(obj instanceof Array){
								str = "["+obj+"]"
							} else if(obj instanceof Object){
								str = "{";
								for(key in obj) {
									str+=key+":"+obj[key]+", ";
								}
								str += "}";
							}
						}
						return str;
					},
clear : function(){
					history_ijcwindow.value = "";
				},
common_substring : function(array) {
										 if(array.length==0) return undefined;
										 if(array.length==1) return array[0];
										 common = array[0];
										 for(i=1;i<array.length;i++){
											 str = array[i];
											 len = str.length > common.length ? str.length : common.length;
											 for(j=0;j<len;j++){
												 if(str[j]!=common[j]) break;
											 }
											 common = common.substr(0,j);
										 }
										 return common;
									 },
				//auto completion
hint : function(word) {
				 stub = context = partial="";
				 //get the last word in the sentence
				 if(m = word.match(/^(.*[^\w.])?(([\w.]+)\.)$/)){
						 //end with '.'
						 stub = (m[1]||"")+(m[2]||"");
						 stub2 = m[2]||"";
						 context = m[3]||"";
						 partial = "";
						 }else if(m = word.match(/^(.*[^\w.])?(([\w.]+)\.)?(\w+)$/)){
						 //context
						 stub = (m[1]||"")+(m[2]||"");
						 stub2 = m[2]||"";
						 context = m[3]||"window";
						 partial = m[4]||"";
						 }
						 try{
							 replacements = [];
						 results = [];
						 r = eval(context);
						 if(typeof(r)=='object' && !(r instanceof Array)){
						 for(key in r){
							 if(key.indexOf(partial)==0 || partial.length==0){
							 replacements.push(stub+key);
							 results.push(stub2+key);
							 }
						 }
						 return {rep: ijc.common_substring(replacements), hints:results};
						 } else {
							 return undefined;
						 }
						 }catch(err){
							 return undefined;
						 }
			 }


	}
ijc.console_ijcwindow.onsubmit = function() {
	var c=ijc.code_ijcwindow;
	var r;
	ijc.puts(">> "+c.value);
	ijc.add_history(c.value);
	try{ r=eval(c.value) } catch(err){ r="Error: "+err.description }
	if(r!=undefined) ijc.puts(ijc.inspect(r));
	c.focus();
	c.select();
	return false;
}
$('#code_ijcwindow').keydown(function(event){
		switch(event.keyCode){
		case 9: //tab
		if(hints = ijc.hint(ijc.code_ijcwindow.value)){
		if(hints.hints.length==0){
		}else if(hints.hints.length==1){
		ijc.code_ijcwindow.value = hints.rep;
		}else{
		ijc.puts('(hint)');
		for(i=0;i<hints.hints.length;i++) ijc.print(hints.hints[i]+"        ");
		ijc.puts('');
		if(hints.rep) ijc.code_ijcwindow.value = hints.rep;
		}
		}
		break;
		case 38://up arrow
		ijc.code_ijcwindow.value= ijc.prev_history()||ijc.code_ijcwindow.value;
		break;
		case 40://down arrow
		ijc.code_ijcwindow.value= ijc.next_history()||ijc.code_ijcwindow.value;
		break;
		default:
		return true;
		}
		return false;
});
//mixin ijc methods into global space
ijc.mixin();
//set focus
ijc.code_ijcwindow.focus();

</script>

